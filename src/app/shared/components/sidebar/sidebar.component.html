<div class="sidebar" [class.collapsed]="collapsed">

  <!-- BRAND -->
  <div class="sidebar-brand" (click)="goRoute('/landing')">
    <img
      class="brand-logo"
      src="assets/company-logo.png"
      alt="Company Logo"
      (error)="onLogoError($event)"
    />
    <!-- <mat-icon class="brand-fallback-icon">apartment</mat-icon> -->

    <!-- <div class="brand-text" *ngIf="!collapsed">
      <div class="brand-name">CriptonERP</div>
      <div class="brand-sub">Company</div>
    </div> -->
  </div>

  <div class="brand-divider" *ngIf="!collapsed"></div>

  <!-- MODULE LIST -->
  <ng-container *ngIf="(activeModule$ | async) === null; else treeMode">
    <div class="module-list">
      <button
        class="module-item"
        *ngFor="let m of (modules$ | async) ?? []"
        (click)="selectModule(m)"
        [matTooltip]="collapsed ? (m.name || '') : ''"
        matTooltipPosition="right"
      >
        <span class="icon">
          <i *ngIf="m.icon && !isMaterialIcon(m.icon)" [class]="m.icon"></i>
          <mat-icon *ngIf="m.icon && isMaterialIcon(m.icon)">{{ m.icon }}</mat-icon>
          <mat-icon *ngIf="!m.icon">apps</mat-icon>
        </span>

        <span class="name" *ngIf="!collapsed">{{ m.name }}</span>
      </button>
    </div>
  </ng-container>

  <!-- TREE MODE -->
  <ng-template #treeMode>

    <div class="tree-loading" *ngIf="(loading$ | async) === true && !collapsed">
      Loading menu...
    </div>

    <ng-container *ngIf="(loading$ | async) !== true">
      <mat-accordion class="tree-accordion" [multi]="true">

        <mat-expansion-panel
          *ngFor="let menu of (filteredMenus$ | async) ?? []"
          class="tree-panel"
          [hideToggle]="true"
        >
          <!-- MENU HEADER -->
          <mat-expansion-panel-header class="tree-header">
            <div
              class="menu-row"
              (click)="openFlyout(menu)"
              [matTooltip]="collapsed ? (menu.title || '') : ''"
              matTooltipPosition="right"
            >
              <span class="menu-icon">
                <i *ngIf="menu.icon && !isMaterialIcon(menu.icon)" [class]="menu.icon"></i>
                <mat-icon *ngIf="menu.icon && isMaterialIcon(menu.icon)">{{ menu.icon }}</mat-icon>
                <mat-icon *ngIf="!menu.icon">folder</mat-icon>
              </span>

              <span class="menu-title" *ngIf="!collapsed">{{ menu.title }}</span>
              <mat-icon class="chev" *ngIf="!collapsed">expand_more</mat-icon>
            </div>
          </mat-expansion-panel-header>

          <!-- ✅ Normal mode: show submenu under accordion -->
          <ng-container *ngIf="!collapsed">
            <ng-container *ngIf="(currentUrl$ | async) as curUrl">

              <button
                class="sub-item"
                *ngIf="menu.route && (!menu.subMenus || menu.subMenus.length === 0)"
                [class.active]="isActiveRoute(curUrl, menu.route)"
                (click)="goRoute(menu.route)"
              >
                <span class="tree-line"></span>
                <span class="sub-text">{{ menu.title }}</span>
              </button>

              <div class="sub-list" *ngIf="(menu.subMenus ?? []).length > 0">
                <button
                  class="sub-item"
                  *ngFor="let sm of (menu.subMenus ?? [])"
                  [class.active]="isActiveRoute(curUrl, sm.route)"
                  (click)="goRoute(sm.route)"
                >
                  <span class="tree-line"></span>
                  <span class="sub-text">{{ sm.title }}</span>
                </button>
              </div>

            </ng-container>
          </ng-container>

        </mat-expansion-panel>

      </mat-accordion>
    </ng-container>

  </ng-template>

  <!-- ✅ Flyout (collapsed mode) -->
  <div class="flyout" *ngIf="collapsed && flyoutOpen">
    <div class="flyout-title">{{ flyoutTitle }}</div>

    <button
      class="flyout-item"
      *ngFor="let it of flyoutItems"
      (click)="goRoute(it.route)"
      [matTooltip]="it.title"
      matTooltipPosition="right"
    >
      <span class="flyout-text">{{ it.title }}</span>
    </button>
  </div>

</div>
